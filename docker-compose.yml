services:
  app:
    build:
      context: .
      dockerfile: Dockerfile
    image: "${DOCKERHUB_USERNAME:-neuro-schedule}/${IMAGE_TAG:-latest}"
    volumes:
      - ./service_account.json:/app/service_account.json:ro
    environment:
      - CALENDAR_ID=${CALENDAR_ID}
      - DISCORD_BOT_TOKEN=${DISCORD_BOT_TOKEN}
      - GOOGLE_APPLICATION_CREDENTIALS=/app/service_account.json
      - ENABLE_LOGS=true
    command: ["python", "-u", "discordtocalendar.py"]
    tty: true

  tests:
    build:
      context: .
      dockerfile: Dockerfile.test
    image: "${DOCKERHUB_USERNAME:-neuro-schedule}/test-${IMAGE_TAG:-latest}"
    volumes:
      - ./service_account.json:/tmp/fake_credentials.json:ro
    environment:
      - CALENDAR_ID=test_calendar
      - DISCORD_BOT_TOKEN=test_token
      - GOOGLE_APPLICATION_CREDENTIALS=/tmp/fake_credentials.json
      - ENABLE_LOGS=false
    command: ["python", "-m", "pytest", "-q"]
    tty: true
