on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  docker-test:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build test image
        run: docker build -f Dockerfile.test -t neuro-schedule:test .

      - name: Run tests inside container and write junit xml to runner temp
        env:
          CALENDAR_ID: test_calendar
          GOOGLE_APPLICATION_CREDENTIALS: /tmp/fake_credentials.json
          ENABLE_LOGS: "false"
          DISCORD_BOT_TOKEN: test_token
        run: |
          mkdir -p $RUNNER_TEMP/test-results
          docker run --rm -v $RUNNER_TEMP/test-results:/work/results \
            neuro-schedule:test pytest --junitxml=/work/results/results.xml -q || true
          # Make sure we don't fail before uploading artifact; next step can fail if needed.

      - name: Upload pytest junit xml
        uses: actions/upload-artifact@v4
        with:
          name: pytest-results
          path: ${{ runner.temp }}/test-results/results.xml

      - name: Fail job if tests failed
        # this will cause the job to fail if pytest returned non-zero (we allowed non-zero above to ensure artifact upload)
        if: always()
        run: |
          if [ -f $RUNNER_TEMP/test-results/results.xml ]; then
            # parse junit xml for failures/errors reliably using Python
            python - <<'PY'
import xml.etree.ElementTree as ET
import os, sys

path = os.path.join(os.environ.get('RUNNER_TEMP','/tmp'), 'test-results', 'results.xml')
try:
    tree = ET.parse(path)
    root = tree.getroot()
    failures = int(root.attrib.get('failures', '0'))
    errors = int(root.attrib.get('errors', '0'))
    tests = int(root.attrib.get('tests', '0'))
except Exception as e:
    print('Failed to parse junit xml:', e)
    sys.exit(1)

if failures == 0 and errors == 0:
    print('No failures found.')
    sys.exit(0)
else:
    print(f'Tests reported failures/errors: failures={failures} errors={errors} tests={tests}')
    sys.exit(1)
PY
          else
            echo "No test results found"
            exit 1
          fi
